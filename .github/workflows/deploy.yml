name: Deploy Frontend

on:
  push:
    branches:
      - master
    paths:
      - 'src/**'
      - 'public/**'
      - 'next.config.js'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy.yml'
  pull_request:
    paths:
      - 'src/**'
      - 'public/**'
      - 'next.config.js'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

# Prevent concurrent deployments
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  AWS_REGION: us-east-1

permissions:
  id-token: write
  contents: read

jobs:
  build:
    name: Build, Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Type check
        run: npm run type-check

      - name: Build Next.js application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Verify build output
        run: |
          echo "Checking build output directory..."
          ls -la out/
          echo "Build completed successfully!"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: out/
          retention-days: 7

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: out/

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify build contents
        run: |
          echo "Contents of out/ directory:"
          ls -laR out/

      - name: Sync to S3
        run: |
          BUCKET_NAME="finedskywalker-client-dev"
          
          echo "Syncing files to S3 bucket: ${BUCKET_NAME}"
          aws s3 sync out/ "s3://${BUCKET_NAME}/" \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html" \
            --exclude "*.json"
          
          # Upload HTML and JSON with shorter cache
          aws s3 sync out/ "s3://${BUCKET_NAME}/" \
            --exclude "*" \
            --include "*.html" \
            --include "*.json" \
            --cache-control "public,max-age=0,must-revalidate"
          
          echo "‚úÖ Files synced to S3"

      - name: Get CloudFront Distribution ID
        id: get-cf-id
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='finEdSkywalker Client - dev'].Id" \
            --output text)
          
          if [ -z "$DISTRIBUTION_ID" ]; then
            echo "‚ùå CloudFront distribution not found"
            exit 1
          fi
          
          echo "distribution_id=${DISTRIBUTION_ID}" >> $GITHUB_OUTPUT
          echo "CloudFront Distribution ID: ${DISTRIBUTION_ID}"

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID="${{ steps.get-cf-id.outputs.distribution_id }}"
          
          echo "Creating CloudFront invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "${DISTRIBUTION_ID}" \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "Invalidation ID: ${INVALIDATION_ID}"
          echo "Waiting for invalidation to complete..."
          
          aws cloudfront wait invalidation-completed \
            --distribution-id "${DISTRIBUTION_ID}" \
            --id "${INVALIDATION_ID}"
          
          echo "‚úÖ CloudFront cache invalidated"

      - name: Get CloudFront URL
        run: |
          DISTRIBUTION_ID="${{ steps.get-cf-id.outputs.distribution_id }}"
          
          DOMAIN_NAME=$(aws cloudfront get-distribution \
            --id "${DISTRIBUTION_ID}" \
            --query 'Distribution.DomainName' \
            --output text)
          
          echo "üöÄ Deployment successful!"
          echo "CloudFront URL: https://${DOMAIN_NAME}"
          echo "::notice title=Deployment Complete::Frontend deployed to https://${DOMAIN_NAME}"

      - name: Verify deployment
        run: |
          DISTRIBUTION_ID="${{ steps.get-cf-id.outputs.distribution_id }}"
          
          DOMAIN_NAME=$(aws cloudfront get-distribution \
            --id "${DISTRIBUTION_ID}" \
            --query 'Distribution.DomainName' \
            --output text)
          
          echo "Testing deployment..."
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" "https://${DOMAIN_NAME}")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Deployment verified! Site is responding."
              exit 0
            else
              echo "‚ö†Ô∏è Got HTTP $HTTP_CODE"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Retrying in 10 seconds..."
                sleep 10
              fi
            fi
          done
          
          echo "‚ö†Ô∏è Verification inconclusive, but deployment completed successfully."
          echo "Please check the CloudFront URL manually."

