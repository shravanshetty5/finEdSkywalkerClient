# Lambda@Edge Function for Dynamic Routes

This Lambda@Edge function handles dynamic routing for the finEdSkywalker Client Next.js application deployed as a static export to S3/CloudFront.

## Purpose

Next.js static export generates static HTML files for each page. However, dynamic routes like `/ticker/[ticker]` need special handling in CloudFront. This Lambda@Edge function intercepts requests and rewrites them to the correct static HTML file.

## How It Works

### Route Matching

The function matches incoming requests against defined route patterns and rewrites them to the corresponding static HTML files.

**Example:**
- Request: `/ticker/AAPL`
- Matches pattern: `/ticker/:ticker`
- Rewrites to: `/ticker/[ticker].html`
- CloudFront serves: `s3://bucket/ticker/[ticker].html`

### Supported Routes

Currently configured routes:

1. **Ticker Detail Page**
   - Pattern: `/ticker/:ticker`
   - File: `/ticker/[ticker].html`
   - Example: `/ticker/AAPL` → `/ticker/[ticker].html`

2. **Static Pages**
   - Pattern: Any non-dynamic path
   - File: `{path}.html`
   - Examples:
     - `/login` → `/login.html`
     - `/search` → `/search.html`

3. **Root Path**
   - Pattern: `/`
   - File: `/index.html`

## File Structure

```
terraform/
├── lambda-edge/
│   ├── index.js           # Lambda function code
│   └── function.zip       # Generated by Terraform
├── lambda-edge.tf         # Lambda@Edge infrastructure
├── s3-cloudfront.tf       # CloudFront distribution with Lambda@Edge association
└── main.tf                # Provider configuration
```

## Lambda Function Details

### Configuration

- **Runtime:** Node.js 20.x
- **Timeout:** 5 seconds
- **Memory:** 128 MB (default)
- **Trigger:** CloudFront Origin Request
- **Region:** us-east-1 (required for Lambda@Edge)

### Event Type

The function is triggered on **origin-request** events, which means:
- Executes before CloudFront forwards the request to S3
- Can modify the request URI
- Doesn't impact CloudFront cache (request modification happens before cache lookup)

### Logging

Logs are written to CloudWatch Logs in the region closest to where the function executes:
- Log group: `/aws/lambda/us-east-1.{function-name}`
- Retention: 7 days
- Location: Varies by CloudFront edge location

## Adding New Dynamic Routes

To add new dynamic routes, update the `routes` array in `lambda-edge/index.js`:

```javascript
const routes = [
  {
    route: '/ticker/:ticker',
    nextJsRoute: '/ticker/[ticker].html'
  },
  // Add new routes here
  {
    route: '/posts/:id',
    nextJsRoute: '/posts/[id].html'
  }
];
```

### Route Pattern Syntax

- **Simple parameter:** `:paramName`
  - Example: `/users/:id` matches `/users/123`
  
- **Multiple parameters:** `:param1/:param2`
  - Example: `/posts/:category/:id` matches `/posts/tech/456`

- **Optional parameter:** `:param?`
  - Example: `/search/:query?` matches both `/search/` and `/search/apple`

- **RegExp:** Use JavaScript RegExp for complex patterns
  - Example: `/^\/api\/v\d+\/users/` matches `/api/v1/users`, `/api/v2/users`, etc.

## Deployment

### Prerequisites

1. **Terraform initialized:**
   ```bash
   cd terraform
   terraform init
   ```

2. **AWS credentials configured:**
   ```bash
   aws configure
   ```

### Deploy Steps

1. **Update Lambda function code:**
   ```bash
   cd terraform/lambda-edge
   # Edit index.js
   ```

2. **Apply Terraform changes:**
   ```bash
   cd ..
   terraform plan
   terraform apply
   ```

3. **Wait for CloudFront propagation:**
   - Lambda@Edge association takes 15-30 minutes to propagate globally
   - Check status: AWS Console → CloudFront → Distributions

### Testing

1. **Deploy the Next.js app:**
   ```bash
   npm run build
   aws s3 sync out/ s3://your-bucket-name/
   ```

2. **Test dynamic routes:**
   ```bash
   # Test ticker route
   curl https://your-cloudfront-domain.cloudfront.net/ticker/AAPL
   
   # Check CloudWatch logs
   aws logs tail /aws/lambda/us-east-1.{function-name} --follow
   ```

## Troubleshooting

### Route not working

1. **Check Lambda logs:**
   ```bash
   aws logs tail /aws/lambda/us-east-1.{function-name} --follow
   ```

2. **Verify function is published:**
   - Lambda@Edge requires published versions
   - Terraform automatically publishes with `publish = true`

3. **Check CloudFront distribution:**
   - Verify Lambda function association is present
   - Check that function version is correct (not `$LATEST`)

### 403/404 Errors

1. **Verify file exists in S3:**
   ```bash
   aws s3 ls s3://your-bucket-name/ticker/
   ```

2. **Check CloudFront error pages:**
   - Custom error responses might be interfering
   - Review `custom_error_response` in `s3-cloudfront.tf`

### Performance Issues

1. **Monitor Lambda execution time:**
   - Check CloudWatch metrics
   - Target: < 100ms execution time

2. **Optimize function code:**
   - Minimize external dependencies
   - Reduce route matching complexity

## Cost Optimization

### Lambda@Edge Pricing

- **Requests:** $0.60 per 1M requests
- **Duration:** $0.00005001 per GB-second

### Estimated Costs (10,000 requests/day)

- **Requests:** ~$0.18/month
- **Duration:** ~$0.15/month (assuming 50ms avg)
- **Total:** ~$0.33/month

### Cost Saving Tips

1. **Cache at CloudFront:**
   - Lambda only runs on cache misses
   - Configure appropriate TTLs

2. **Optimize function:**
   - Reduce execution time
   - Use efficient route matching

3. **Monitor usage:**
   - Review CloudWatch metrics
   - Set billing alarms

## Security Considerations

1. **IAM Permissions:**
   - Function has minimal permissions (logs only)
   - No access to S3 or other AWS services

2. **Input Validation:**
   - Function sanitizes URI parameters
   - Prevents path traversal attacks

3. **Logging:**
   - All requests are logged
   - PII should be avoided in URLs

## References

- [AWS Lambda@Edge Documentation](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-at-edge.html)
- [Next.js Static Export](https://nextjs.org/docs/pages/building-your-application/deploying/static-exports)
- [CloudFront Origin Request Events](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-event-structure.html#example-origin-request)

